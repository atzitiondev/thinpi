#if 0
	shc Version 3.9.6, Generic Shell Script Compiler
	GNU GPL Version 3 Md Jahidul Hamid <jahidulhamid@yahoo.com>

	shc -f src/thinpi/tpupdate/tpupdate 
#endif

static  char data [] = 
#define      xecc_z	15
#define      xecc	((&data[2]))
	"\014\077\230\310\217\326\077\053\304\342\072\021\363\134\276\153"
	"\360\131"
#define      msg2_z	19
#define      msg2	((&data[18]))
	"\372\351\127\202\345\367\353\327\075\051\227\021\172\314\200\317"
	"\331\345\230\022\150\000"
#define      pswd_z	256
#define      pswd	((&data[76]))
	"\172\020\356\274\034\135\351\054\026\347\036\200\304\273\270\366"
	"\021\141\131\035\240\262\302\265\143\324\035\143\342\254\026\135"
	"\274\004\031\331\027\261\060\052\346\230\006\143\150\316\154\072"
	"\141\051\165\327\257\220\347\243\266\317\015\136\165\372\077\132"
	"\131\214\212\160\075\272\232\044\122\241\207\273\160\364\366\321"
	"\035\154\251\314\374\220\160\263\137\176\021\325\170\120\060\321"
	"\335\272\102\032\165\335\076\310\176\306\204\357\272\172\301\330"
	"\346\152\245\343\372\026\226\132\224\250\057\015\371\137\337\326"
	"\032\041\361\217\376\060\127\175\366\333\154\261\126\055\212\075"
	"\227\057\041\222\106\270\354\332\140\034\347\131\174\306\057\226"
	"\350\041\046\346\121\176\143\107\132\320\371\261\375\203\356\225"
	"\263\017\047\371\307\024\324\050\060\274\201\255\203\261\103\153"
	"\322\152\121\043\350\265\153\102\205\145\363\203\350\342\030\234"
	"\362\100\226\272\124\152\342\205\046\144\062\252\025\166\025\347"
	"\340\147\013\310\035\167\013\242\334\377\045\305\341\076\141\324"
	"\176\367\216\323\142\161\131\211\325\213\063\352\002\111\322\342"
	"\261\335\253\316\124\267\160\061\266\226\366\230\324\127\155\123"
	"\117\373\047\262\154\200\073\101\014\157\054\017\270\376\362\151"
	"\334\235\070\061\142\002\005\171\352\043\371\257\337\261\245\361"
	"\023\376\016\264\261\321\151\024\246\206\170\210\063\217\346\360"
	"\224\377\312\366\002\320\157\355\363\151\234\323\033\102\304\056"
	"\101"
#define      text_z	800
#define      text	((&data[555]))
	"\244\114\007\112\322\177\323\006\016\271\366\242\271\300\231\274"
	"\220\010\251\204\161\106\130\215\211\035\273\312\360\236\274\224"
	"\352\303\337\275\103\263\303\121\154\272\364\046\172\215\342\013"
	"\226\214\220\010\323\350\225\134\006\120\046\366\357\343\213\331"
	"\247\152\227\353\035\132\074\212\024\061\261\217\277\223\233\125"
	"\040\054\136\364\025\363\120\033\104\167\021\063\133\234\015\002"
	"\007\244\355\045\377\052\257\024\134\141\244\033\364\100\161\025"
	"\154\317\011\201\302\132\235\007\321\256\073\054\113\110\057\123"
	"\355\035\170\354\110\050\001\244\211\245\300\176\346\061\223\122"
	"\001\235\324\303\367\161\313\311\040\006\366\153\117\045\276\074"
	"\103\067\051\214\137\052\061\351\320\361\147\266\043\373\011\044"
	"\231\335\274\361\135\145\003\344\250\215\014\371\071\022\226\217"
	"\024\064\070\051\074\313\020\012\134\072\174\270\077\276\330\307"
	"\213\124\372\060\055\015\142\272\126\162\127\143\031\305\307\126"
	"\173\305\333\017\113\107\250\053\061\062\026\015\346\034\330\306"
	"\077\324\251\213\320\343\246\215\064\145\371\333\376\065\062\007"
	"\320\166\170\332\042\022\031\027\051\135\225\252\346\360\107\253"
	"\174\326\106\003\253\034\252\242\043\043\346\365\021\224\331\176"
	"\015\075\367\217\372\113\052\326\006\011\124\070\347\274\143\275"
	"\171\047\116\231\147\176\114\053\051\372\017\256\024\152\106\072"
	"\126\304\024\223\331\016\056\347\131\055\043\336\300\206\123\261"
	"\026\355\305\101\343\364\002\111\177\117\036\016\107\344\346\105"
	"\233\343\130\266\372\051\176\032\307\236\154\052\235\353\123\362"
	"\216\056\031\331\013\066\370\022\133\331\371\045\142\317\341\020"
	"\173\023\210\301\211\321\151\001\073\236\010\216\177\016\231\144"
	"\021\116\017\332\217\351\111\353\265\252\361\275\125\102\117\242"
	"\301\352\222\034\024\357\067\200\010\333\153\272\112\166\231\154"
	"\147\366\015\262\116\014\076\122\054\063\264\206\301\103\350\016"
	"\063\024\037\232\112\251\231\233\072\350\057\001\370\147\077\327"
	"\213\266\011\040\370\325\071\277\074\301\017\337\072\121\135\336"
	"\340\045\344\037\370\020\310\032\250\075\162\235\224\263\005\170"
	"\256\300\027\105\012\352\211\303\355\370\224\051\134\051\111\246"
	"\317\071\253\356\302\012\016\345\234\237\037\322\354\020\067\262"
	"\040\053\062\345\263\276\216\140\375\262\255\330\130\043\360\277"
	"\012\014\076\160\252\353\026\346\112\365\205\006\231\175\336\202"
	"\321\040\000\241\274\013\245\154\263\224\312\051\070\302\176\021"
	"\007\106\340\046\330\333\222\047\022\344\352\112\110\040\360\342"
	"\132\230\107\164\276\126\352\356\271\323\373\330\256\103\037\376"
	"\040\365\062\322\215\205\154\047\165\063\253\127\354\236\177\037"
	"\354\225\005\121\363\150\160\064\246\147\162\122\065\207\027\366"
	"\370\265\312\225\223\362\022\145\365\135\053\351\130\373\070\331"
	"\043\047\157\003\352\174\242\106\064\330\351\017\050\217\275\067"
	"\271\230\142\244\303\127\142\115\025\141\172\331\041\117\356\310"
	"\126\175\002\266\337\016\315\227\236\267\271\350\277\340\173\126"
	"\270\346\002\367\352\170\370\333\060\253\362\030\363\321\043\326"
	"\077\104\125\305\104\213\243\026\242\256\162\232\317\246\173\235"
	"\373\254\303\200\073\223\211\114\126\163\112\224\025\262\123\336"
	"\026\025\145\136\175\164\037\164\237\037\312\200\077\316\150\145"
	"\264\040\245\177\271\041\002\010\270\315\101\356\101\170\206\036"
	"\077\041\037\352\166\250\130\011\241\273\144\152\207\112\027\110"
	"\302\116\151\237\065\254\250\221\016\063\274\343\051\123\162\125"
	"\213\036\317\005\273\367\367\332\342\364\240\242\232\032\033\267"
	"\116\225\352\050\274\346\164\020\307\141\351\266\240\353\163\055"
	"\304\001\354\227\013\003\314\324\134\153\007\022\062\010\266\324"
	"\266\245\155\217\274\352\000\146\233\361\327\262\270\215\347\031"
	"\037\321\320\235\055\160\116\345\254\335\210\144\047\325\112\204"
	"\133\241\343\060\152\254\274\115\256\135\006\321\156\207\171\064"
	"\136\235\156\105\332\034\320\044\377\053\075\065\174\162\177\351"
	"\264\325\251\165\342\071\061\137\344\300\074\123\225\064\224\216"
	"\054\116\170\123\171\054\304\324\252\054\036\053\161\240\236\174"
	"\060\000\003\051\037\075\354\143\134\212\213\036\160\362\276\234"
	"\031\357\350\220\117\263\131\157\272\120\333\011\165\232\105\271"
	"\321\157\105\061\231\166\033\151\150\202\040\213\176\051\260\027"
	"\007\231\250\126\115\002\305\007\122\241\021\310\073\126\201\015"
	"\306\307\077\137\076\132\311\246\334\352\062\133\023\343\163\032"
	"\174\033\161\311\035\067\321\160\330\342\070\024\071\272\041\377"
	"\202\140\137\300\272\050\146\227\023\231\362\046\174\146\101\371"
	"\201\262\303\237\351\224\017\302\167\110\326\261\003\370\260\205"
	"\131\020\105\023\071\254\253\114\105\236\162\302\004\264\273\206"
	"\146\177\045\120\023\065\023\213\176\352\074\201\342\354\006\073"
	"\375\114\117\066\370\373\202\076\231\365\001\236\251\275\044\020"
	"\074\111\141\117\177\164\332\375\136\027\176\101\004\205\175\001"
	"\321\315\067\312\310\271\011\142\256\012\000\130\307\044\150\003"
#define      lsto_z	1
#define      lsto	((&data[1545]))
	"\006"
#define      tst2_z	19
#define      tst2	((&data[1547]))
	"\352\355\150\351\232\055\273\215\331\265\375\100\102\344\141\300"
	"\073\332\357\065"
#define      rlax_z	1
#define      rlax	((&data[1566]))
	"\227"
#define      chk2_z	19
#define      chk2	((&data[1568]))
	"\133\333\156\121\037\234\250\146\024\137\134\326\131\314\121\373"
	"\304\015\026\154\113\300\050\202"
#define      chk1_z	22
#define      chk1	((&data[1596]))
	"\224\123\352\236\123\240\134\326\346\126\352\250\334\041\325\227"
	"\210\302\135\327\104\146\122\235\010\104\276\102"
#define      tst1_z	22
#define      tst1	((&data[1621]))
	"\152\345\165\332\225\110\007\374\256\113\015\172\134\233\073\361"
	"\173\074\353\366\363\273\347\147\164\275\323\262"
#define      msg1_z	65
#define      msg1	((&data[1659]))
	"\062\047\055\174\026\211\307\326\261\111\142\243\033\026\037\214"
	"\050\067\001\361\304\111\261\367\371\323\340\021\241\312\235\054"
	"\027\251\224\240\020\226\336\073\050\235\144\337\230\147\252\345"
	"\312\160\024\213\045\045\024\071\350\050\077\136\240\245\210\074"
	"\357\126\345\175\147\242\034\107\005\124\057\051\255\205\366\366"
	"\160\224"
#define      inlo_z	3
#define      inlo	((&data[1729]))
	"\165\173\236"
#define      opts_z	1
#define      opts	((&data[1732]))
	"\334"
#define      date_z	1
#define      date	((&data[1733]))
	"\057"
#define      shll_z	10
#define      shll	((&data[1735]))
	"\070\067\164\277\353\265\035\250\206\001\124"/* End of data[] */;
#define      hide_z	4096
#define DEBUGEXEC	0	/* Define as 1 to debug execvp calls */
#define TRACEABLE	1	/* Define as 1 to enable ptrace the executable */
#define BUSYBOXON	0	/* Define as 1 to enable work with busybox */

/* rtc.c */

#include <sys/stat.h>
#include <sys/types.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

/* 'Alleged RC4' */

static unsigned char stte[256], indx, jndx, kndx;

/*
 * Reset arc4 stte. 
 */
void stte_0(void)
{
	indx = jndx = kndx = 0;
	do {
		stte[indx] = indx;
	} while (++indx);
}

/*
 * Set key. Can be used more than once. 
 */
void key(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		do {
			tmp = stte[indx];
			kndx += tmp;
			kndx += ptr[(int)indx % len];
			stte[indx] = stte[kndx];
			stte[kndx] = tmp;
		} while (++indx);
		ptr += 256;
		len -= 256;
	}
}

/*
 * Crypt data. 
 */
void arc4(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		indx++;
		tmp = stte[indx];
		jndx += tmp;
		stte[indx] = stte[jndx];
		stte[jndx] = tmp;
		tmp += stte[indx];
		*ptr ^= stte[tmp];
		ptr++;
		len--;
	}
}

/* End of ARC4 */

/*
 * Key with file invariants. 
 */
int key_with_file(char * file)
{
	struct stat statf[1];
	struct stat control[1];

	if (stat(file, statf) < 0)
		return -1;

	/* Turn on stable fields */
	memset(control, 0, sizeof(control));
	control->st_ino = statf->st_ino;
	control->st_dev = statf->st_dev;
	control->st_rdev = statf->st_rdev;
	control->st_uid = statf->st_uid;
	control->st_gid = statf->st_gid;
	control->st_size = statf->st_size;
	control->st_mtime = statf->st_mtime;
	control->st_ctime = statf->st_ctime;
	key(control, sizeof(control));
	return 0;
}

#if DEBUGEXEC
void debugexec(char * sh11, int argc, char ** argv)
{
	int i;
	fprintf(stderr, "shll=%s\n", sh11 ? sh11 : "<null>");
	fprintf(stderr, "argc=%d\n", argc);
	if (!argv) {
		fprintf(stderr, "argv=<null>\n");
	} else { 
		for (i = 0; i <= argc ; i++)
			fprintf(stderr, "argv[%d]=%.60s\n", i, argv[i] ? argv[i] : "<null>");
	}
}
#endif /* DEBUGEXEC */

void rmarg(char ** argv, char * arg)
{
	for (; argv && *argv && *argv != arg; argv++);
	for (; argv && *argv; argv++)
		*argv = argv[1];
}

void chkenv_end(void);

int chkenv(int argc)
{
	char buff[512];
	unsigned long mask, m;
	int l, a, c;
	char * string;
	extern char ** environ;

	mask = (unsigned long)getpid();
	stte_0();
	 key(&chkenv, (void*)&chkenv_end - (void*)&chkenv);
	 key(&data, sizeof(data));
	 key(&mask, sizeof(mask));
	arc4(&mask, sizeof(mask));
	sprintf(buff, "x%lx", mask);
	string = getenv(buff);
#if DEBUGEXEC
	fprintf(stderr, "getenv(%s)=%s\n", buff, string ? string : "<null>");
#endif
	l = strlen(buff);
	if (!string) {
		/* 1st */
		sprintf(&buff[l], "=%lu %d", mask, argc);
		putenv(strdup(buff));
		return 0;
	}
	c = sscanf(string, "%lu %d%c", &m, &a, buff);
	if (c == 2 && m == mask) {
		/* 3rd */
		rmarg(environ, &string[-l - 1]);
		return 1 + (argc - a);
	}
	return -1;
}

void chkenv_end(void){}

#if !TRACEABLE

#define _LINUX_SOURCE_COMPAT
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

#if !defined(PTRACE_ATTACH) && defined(PT_ATTACH)
#	define PTRACE_ATTACH	PT_ATTACH
#endif
void untraceable(char * argv0)
{
	char proc[80];
	int pid, mine;

	switch(pid = fork()) {
	case  0:
		pid = getppid();
		/* For problematic SunOS ptrace */
#if defined(__FreeBSD__)
		sprintf(proc, "/proc/%d/mem", (int)pid);
#else
		sprintf(proc, "/proc/%d/as",  (int)pid);
#endif
		close(0);
		mine = !open(proc, O_RDWR|O_EXCL);
		if (!mine && errno != EBUSY)
			mine = !ptrace(PTRACE_ATTACH, pid, 0, 0);
		if (mine) {
			kill(pid, SIGCONT);
		} else {
			perror(argv0);
			kill(pid, SIGKILL);
		}
		_exit(mine);
	case -1:
		break;
	default:
		if (pid == waitpid(pid, 0, 0))
			return;
	}
	perror(argv0);
	_exit(1);
}
#endif /* !TRACEABLE */

char * xsh(int argc, char ** argv)
{
	char * scrpt;
	int ret, i, j;
	char ** varg;
	char * me = argv[0];
	if (me == NULL) { me = getenv("_"); }
	if (me == 0) { fprintf(stderr, "E: neither argv[0] nor $_ works."); exit(1); }

	ret = chkenv(argc);
	stte_0();
	 key(pswd, pswd_z);
	arc4(msg1, msg1_z);
	arc4(date, date_z);
	if (date[0] && (atoll(date)<time(NULL)))
		return msg1;
	arc4(shll, shll_z);
	arc4(inlo, inlo_z);
	arc4(xecc, xecc_z);
	arc4(lsto, lsto_z);
	arc4(tst1, tst1_z);
	 key(tst1, tst1_z);
	arc4(chk1, chk1_z);
	if ((chk1_z != tst1_z) || memcmp(tst1, chk1, tst1_z))
		return tst1;
	arc4(msg2, msg2_z);
	if (ret < 0)
		return msg2;
	varg = (char **)calloc(argc + 10, sizeof(char *));
	if (!varg)
		return 0;
	if (ret) {
		arc4(rlax, rlax_z);
		if (!rlax[0] && key_with_file(shll))
			return shll;
		arc4(opts, opts_z);
		arc4(text, text_z);
		arc4(tst2, tst2_z);
		 key(tst2, tst2_z);
		arc4(chk2, chk2_z);
		if ((chk2_z != tst2_z) || memcmp(tst2, chk2, tst2_z))
			return tst2;
		/* Prepend hide_z spaces to script text to hide it. */
		scrpt = malloc(hide_z + text_z);
		if (!scrpt)
			return 0;
		memset(scrpt, (int) ' ', hide_z);
		memcpy(&scrpt[hide_z], text, text_z);
	} else {			/* Reexecute */
		if (*xecc) {
			scrpt = malloc(512);
			if (!scrpt)
				return 0;
			sprintf(scrpt, xecc, me);
		} else {
			scrpt = me;
		}
	}
	j = 0;
#if BUSYBOXON
	varg[j++] = "busybox";
	varg[j++] = "sh";
#else
	varg[j++] = argv[0];		/* My own name at execution */
#endif
	if (ret && *opts)
		varg[j++] = opts;	/* Options on 1st line of code */
	if (*inlo)
		varg[j++] = inlo;	/* Option introducing inline code */
	varg[j++] = scrpt;		/* The script itself */
	if (*lsto)
		varg[j++] = lsto;	/* Option meaning last option */
	i = (ret > 1) ? ret : 0;	/* Args numbering correction */
	while (i < argc)
		varg[j++] = argv[i++];	/* Main run-time arguments */
	varg[j] = 0;			/* NULL terminated array */
#if DEBUGEXEC
	debugexec(shll, j, varg);
#endif
	execvp(shll, varg);
	return shll;
}

int main(int argc, char ** argv)
{
#if DEBUGEXEC
	debugexec("main", argc, argv);
#endif
#if !TRACEABLE
	untraceable(argv[0]);
#endif
	argv[1] = xsh(argc, argv);
	fprintf(stderr, "%s%s%s: %s\n", argv[0],
		errno ? ": " : "",
		errno ? strerror(errno) : "",
		argv[1] ? argv[1] : "<null>"
	);
	return 1;
}
